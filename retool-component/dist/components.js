var Le=Object.create;var ue=Object.defineProperty;var Ne=Object.getOwnPropertyDescriptor;var He=Object.getOwnPropertyNames;var Oe=Object.getPrototypeOf,Ve=Object.prototype.hasOwnProperty;var Ue=(n,i)=>()=>(i||n((i={exports:{}}).exports,i),i.exports);var je=(n,i,a,g)=>{if(i&&typeof i=="object"||typeof i=="function")for(let p of He(i))!Ve.call(n,p)&&p!==a&&ue(n,p,{get:()=>i[p],enumerable:!(g=Ne(i,p))||g.enumerable});return n};var $e=(n,i,a)=>(a=n!=null?Le(Oe(n)):{},je(i||!n||!n.__esModule?ue(a,"default",{value:n,enumerable:!0}):a,n));var ge=Ue((sn,pe)=>{pe.exports=window.ccc_support_React});var l=$e(ge());var{Retool:m}=window.ccc_support_RetoolCustomComponenCollections;var{Fragment:ht,jsxs:d,jsx:o,default:ln}=window.ccc_support_ReactJSXRuntime;var qe=n=>{if(n==null||n===""||n==="nan")return"";let i=String(n);if(/^\d{4}-\d{2}-\d{2}/.test(i)){let a=new Date(i);if(!isNaN(a.getTime()))return a.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})}return i},U=(n,i)=>n?(typeof n=="string"?n:String(n)).replace(/\{(\w+)\}/g,(g,p)=>qe(i[p])):"",Ye=(n,i)=>{let a=typeof n=="string"?n:String(n||""),g=U(a,i),p=a.replace(/\{(\w+)\}/g,"");return g.trim()===p.trim()||g.trim()===""},Z=36e5,At=n=>{if(!n)return null;let a=n.split("T")[0].split("-").map(Number);if(a.length!==3||a.some(isNaN))return null;let g=new Date(a[0],a[1]-1,a[2],0,0,0,0);return isNaN(g.getTime())?null:g},Ge=n=>{let i=new Date(n);return i.setHours(0,0,0,0),i},fe=n=>n.getDay()!==0&&n.getDay()!==6,jt=(n,i)=>{let a=new Date(n);for(a.setHours(i,0,0,0);a.getDay()===0||a.getDay()===6;)a.setDate(a.getDate()+1);return a},at=(n,i,a,g)=>{let p=new Date(n);!fe(p)||p.getHours()>=g?p=jt(new Date(p.getTime()+Z*12),a):p.getHours()<a&&p.setHours(a,0,0,0);let R=i,D=new Date(p);for(;R>0;){if(!fe(D)){D=jt(new Date(D.getTime()+Z*12),a);continue}let W=g-D.getHours(),P=Math.min(R,W);D.setTime(D.getTime()+P*Z),R-=P,R>0&&(D=jt(new Date(D.getTime()+Z*12),a))}return D},Ke=(n,i)=>{let a=[],g=new Date(n);for(let p=0;p<i;p++)a.push(new Date(g)),g.setDate(g.getDate()+1);return a},Je=(n,i)=>{let a=[],g=new Date(n);for(;g.getDay()!==1;)g.setDate(g.getDate()-1);let p=new Date(n);for(p.setDate(p.getDate()+i);g<p;)a.push(new Date(g)),g.setDate(g.getDate()+7);return a},Y=(n,i)=>(i.getTime()-n.getTime())/Z,Qe=n=>`W/C ${n.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})}`,Xe=n=>{if(!n||n==="nan")return"In Progress";let i=n.toLowerCase().trim();return i==="ready"?"Ready":i==="parts not assigned"?"Parts Not Assigned":"In Progress"},Ze=(n,i=null)=>{let a=Xe(n.part_status);if(a==="Ready")return"Ready";if(a==="Parts Not Assigned")return"Parts Not Assigned";if(i&&n.part_ready_date){let g=At(n.part_ready_date),p=Ge(i);if(g&&p)return g.getTime()>p.getTime()?"Delayed":"On Time"}return"In Progress"},bt=n=>n.status==="Running",qt={Running:"#9333EA",Ready:"#22C55E","On Time":"#E5A00D",Delayed:"#EF4444","Parts Not Assigned":"#9CA3AF","In Progress":"#D1D5DB"},ye={Running:"#7E22CE",Ready:"#16A34A","On Time":"#B45309",Delayed:"#DC2626","Parts Not Assigned":"#6B7280","In Progress":"#9CA3AF"},lt=n=>qt[n]||qt["In Progress"],_t=n=>ye[n]||ye["In Progress"],Bt=(n,i=null)=>bt(n)?"Running":Ze(n,i),Yt=n=>{let a=Math.max(0,Math.min(100,typeof n=="number"?n:50));return a<=30?"#6B7280":a<=60?"#F59E0B":a<=80?"#EA580C":"#DC2626"};var h={container:{display:"flex",height:"100%",background:"#F9FAFB",overflow:"hidden",fontFamily:"'DM Sans', sans-serif",position:"relative"},sidebar:{width:320,minWidth:320,background:"#FFFFFF",borderRight:"1px solid #E5E7EB",display:"flex",flexDirection:"column"},mono:{fontFamily:"'JetBrains Mono', monospace"}},me=()=>d("div",{style:{position:"absolute",top:2,bottom:2,width:3,background:"#3B82F6",borderRadius:2,zIndex:30,boxShadow:"0 0 12px #3B82F6, 0 0 4px #3B82F6",pointerEvents:"none"},children:[o("div",{style:{position:"absolute",top:-4,left:-4,width:11,height:11,borderRadius:"50%",background:"#3B82F6"}}),o("div",{style:{position:"absolute",bottom:-4,left:-4,width:11,height:11,borderRadius:"50%",background:"#3B82F6"}})]}),tn=()=>d("div",{style:{padding:"10px 16px",borderTop:"1px solid #E5E7EB",background:"#F9FAFB"},children:[o("h3",{style:{...h.mono,fontSize:11,fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",color:"#4B5563",marginBottom:6},children:"Status Key"}),o("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px 0"},children:["Running","Ready","On Time","Delayed","Parts Not Assigned"].map(n=>d("div",{style:{display:"flex",alignItems:"center",gap:6,width:"50%",minWidth:0},children:[o("div",{style:{width:4,height:14,background:qt[n],borderRadius:2,flexShrink:0}}),o("span",{style:{...h.mono,fontSize:9,color:_t(n),fontWeight:600,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:n.toUpperCase()})]},n))})]}),kt=({label:n,icon:i,onClick:a})=>{let[g,p]=l.default.useState(!1);return d("div",{onMouseEnter:()=>p(!0),onMouseLeave:()=>p(!1),onClick:a,style:{padding:"8px 14px",fontSize:13,fontWeight:500,color:"#111827",cursor:"pointer",background:g?"#F3F4F6":"transparent",display:"flex",alignItems:"center",gap:8,userSelect:"none"},children:[i&&o("span",{style:{fontSize:14,width:18,textAlign:"center",color:"#6B7280"},children:i}),n]})},en=({menu:n,statusOptionsList:i,priorityInputValue:a,onClose:g,onModeChange:p,onPriorityInputChange:R,onConfirmPriority:D,onPickStatus:W,onEditTest:P,panelRef:j})=>{let dt=Math.min(n.x,window.innerWidth-210),G=Math.min(n.y,window.innerHeight-150);return d("div",{ref:j,onContextMenu:F=>F.preventDefault(),style:{position:"fixed",left:dt,top:G,zIndex:3e3,background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:10,boxShadow:"0 4px 16px rgba(0,0,0,0.12), 0 1px 4px rgba(0,0,0,0.06)",minWidth:200,overflow:"hidden"},children:[o("div",{style:{padding:"10px 14px 8px",borderBottom:"1px solid #E5E7EB",background:"#F9FAFB"},children:o("div",{style:{fontSize:13,fontWeight:700,color:"#111827",lineHeight:1.3,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:180},children:n.test.name})}),n.mode==="root"&&d("div",{style:{padding:"4px 0"},children:[o(kt,{label:"Change Priority",icon:"\u2B06",onClick:()=>p("priority")}),o(kt,{label:"Change Status",icon:"\u25C9",onClick:()=>p("status")}),o(kt,{label:"Edit Test",icon:"\u270E",onClick:P})]}),n.mode==="priority"&&d("div",{style:{padding:"10px 14px"},children:[o("div",{style:{fontSize:12,color:"#6B7280",marginBottom:8},children:"Enter priority (0\u2013100):"}),o("input",{type:"number",min:0,max:100,autoFocus:!0,value:a,onChange:F=>R(F.target.value),onKeyDown:F=>{F.key==="Enter"&&D(),F.key==="Escape"&&g()},style:{width:"100%",boxSizing:"border-box",padding:"6px 8px",fontSize:13,borderRadius:6,border:"1px solid #D1D5DB",outline:"none",marginBottom:8}}),d("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[o("button",{onClick:D,style:{flex:1,padding:"6px 0",fontSize:12,fontWeight:600,background:"#3B82F6",color:"#FFFFFF",border:"none",borderRadius:6,cursor:"pointer"},children:"Confirm"}),o("span",{onClick:g,style:{fontSize:12,color:"#6B7280",cursor:"pointer",textDecoration:"underline"},children:"Cancel"})]})]}),n.mode==="status"&&o("div",{style:{padding:"4px 0"},children:i.map(F=>o(kt,{label:F==="NULL"?"Clear Status (NULL)":F,onClick:()=>W(F)},F))})]})},nn=({isError:n,onRetry:i,onDiscard:a})=>d("div",{style:{position:"absolute",inset:0,zIndex:2e3,background:"rgba(249,250,251,0.82)",display:"flex",alignItems:"center",justifyContent:"center"},children:[o("style",{children:"@keyframes ccl-spin { to { transform: rotate(360deg); } }"}),n?d("div",{style:{background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:12,boxShadow:"0 4px 20px rgba(0,0,0,0.12)",padding:"24px 28px",display:"flex",flexDirection:"column",alignItems:"center",gap:12,maxWidth:300},children:[o("div",{style:{width:40,height:40,borderRadius:"50%",background:"#FEF2F2",border:"1px solid #FECACA",display:"flex",alignItems:"center",justifyContent:"center",fontSize:20,color:"#EF4444",fontWeight:700},children:"!"}),o("div",{style:{fontSize:15,fontWeight:700,color:"#111827"},children:"Save failed"}),o("div",{style:{fontSize:12,color:"#6B7280",textAlign:"center",lineHeight:1.5},children:"The allocation could not be saved. You can retry or discard your changes."}),d("div",{style:{display:"flex",gap:8,marginTop:4},children:[o("button",{onClick:a,style:{padding:"7px 16px",fontSize:12,fontWeight:600,borderRadius:6,border:"1px solid #D1D5DB",cursor:"pointer",background:"#FFFFFF",color:"#374151"},children:"Discard"}),o("button",{onClick:i,style:{padding:"7px 16px",fontSize:12,fontWeight:600,borderRadius:6,border:"none",cursor:"pointer",background:"#3B82F6",color:"#FFFFFF",boxShadow:"0 1px 3px rgba(59,130,246,0.3)"},children:"Retry"})]})]}):d("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:12},children:[o("div",{style:{width:32,height:32,borderRadius:"50%",border:"3px solid #E5E7EB",borderTopColor:"#3B82F6",animation:"ccl-spin 0.7s linear infinite"}}),o("span",{style:{fontSize:13,fontWeight:600,color:"#374151"},children:"Saving\u2026"})]})]}),he=({testName:n,priority:i,status:a,tooltipLines:g,scheduled:p,wrapperStyle:R,children:D})=>{let[W,P]=l.default.useState(!1),[j,dt]=l.default.useState({x:0,y:0,bottom:0}),[G,F]=l.default.useState(!1),ct=(0,l.useRef)(null),ut=(0,l.useRef)(null),K=(0,l.useRef)(null),J=(0,l.useCallback)(()=>{if(ut.current){let w=ut.current.getBoundingClientRect();dt({x:w.left+w.width/2,y:w.top,bottom:w.bottom})}ct.current=window.setTimeout(()=>P(!0),400)},[]),It=(0,l.useCallback)(()=>{ct.current&&clearTimeout(ct.current),P(!1),F(!1)},[]);l.default.useLayoutEffect(()=>{W&&K.current&&K.current.getBoundingClientRect().top<0&&F(!0)},[W,j]);let Q=g.split(`
`).filter(w=>{let $=w.split(":");return $.length<2?w.trim()!=="":$.slice(1).join(":").trim()!==""}),z=d("div",{style:{background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:10,boxShadow:"0 4px 16px rgba(0,0,0,0.12), 0 1px 4px rgba(0,0,0,0.06)",padding:"12px 16px",maxWidth:300,minWidth:180},children:[o("div",{style:{fontSize:13,fontWeight:700,color:"#111827",marginBottom:6,lineHeight:1.3},children:n}),d("div",{style:{display:"flex",gap:10,alignItems:"center",marginBottom:8},children:[d("span",{style:{fontSize:13,fontWeight:700,color:Yt(i)},children:["P",i]}),o("span",{style:{fontSize:11,fontWeight:700,color:_t(a),textTransform:"uppercase",letterSpacing:"0.05em",padding:"1px 6px",background:`${lt(a)}18`,borderRadius:4,border:`1px solid ${lt(a)}40`},children:a})]}),o("div",{style:{height:1,background:"#E5E7EB",margin:"0 -4px 8px"}}),Q.map((w,$)=>{let tt=w.indexOf(":");if(tt===-1)return o("div",{style:{fontSize:11,color:"#374151",marginBottom:3,lineHeight:1.4},children:w},$);let St=w.slice(0,tt).trim(),Dt=w.slice(tt+1).trim();return d("div",{style:{display:"flex",gap:6,fontSize:11,marginBottom:3,lineHeight:1.4},children:[d("span",{style:{color:"#6B7280",fontWeight:500,flexShrink:0},children:[St,":"]}),o("span",{style:{color:"#111827",fontWeight:400},children:Dt})]},$)}),p&&d(ht,{children:[o("div",{style:{height:1,background:"#E5E7EB",margin:"6px -4px 6px"}}),d("div",{style:{display:"flex",gap:6,fontSize:11,marginBottom:2},children:[o("span",{style:{color:"#6B7280",fontWeight:500},children:"Starts:"}),o("span",{style:{color:"#111827"},children:p.start.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})})]}),d("div",{style:{display:"flex",gap:6,fontSize:11},children:[o("span",{style:{color:"#6B7280",fontWeight:500},children:"Ends:"}),o("span",{style:{color:"#111827"},children:p.end.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})})]})]})]}),vt=o("div",{style:{width:10,height:10,background:"#FFFFFF",border:"1px solid #E5E7EB",borderTop:"none",borderLeft:"none",transform:"rotate(45deg)",margin:"-6px auto 0"}}),xt=o("div",{style:{width:10,height:10,background:"#FFFFFF",border:"1px solid #E5E7EB",borderBottom:"none",borderRight:"none",transform:"rotate(45deg)",margin:"0 auto -6px"}});return d("div",{ref:ut,onMouseEnter:J,onMouseLeave:It,style:R||{position:"relative"},children:[D,W&&o("div",{ref:K,style:{position:"fixed",left:j.x,top:G?j.bottom+8:j.y-8,transform:G?"translate(-50%, 0)":"translate(-50%, -100%)",zIndex:1e3,pointerEvents:"none"},children:G?d(ht,{children:[xt,z]}):d(ht,{children:[z,vt]})})]})},Rt=n=>{let i=[];return n.forEach(a=>{a.tests.forEach((g,p)=>{i.push({test_id:g.id,test_stand_id:a.id,priority_order:p+1})})}),i},$t=n=>JSON.stringify(n.map(i=>`${i.test_id}:${i.test_stand_id}:${i.priority_order}`).sort()),pn=()=>{let[n]=m.useStateArray({name:"tests",initialValue:[],inspector:"text",label:"Tests Data",description:"Array of test objects from getSchedulerData query"}),[i]=m.useStateArray({name:"testStands",initialValue:[],inspector:"text",label:"Test Stands Data",description:"Array of test stand objects from getTestStands query"}),[a]=m.useStateEnumeration({name:"saveMode",initialValue:"batch",enumDefinition:["batch","live"],inspector:"segmented",label:"Save Mode",description:"batch = save button, live = emit on every change"}),[g]=m.useStateBoolean({name:"isSaving",initialValue:!1,inspector:"checkbox",label:"Is Saving",description:"Bind to: {{ saveAllocations.isFetching }}"}),[p]=m.useStateBoolean({name:"hasSaveError",initialValue:!1,inspector:"checkbox",label:"Has Save Error",description:"Bind to: {{ !!saveAllocations.error }}"}),[R]=m.useStateString({name:"savedAt",initialValue:"",inspector:"text",label:"Saved At",description:"Bind to: {{ saveAllocations.lastRunAt }}"}),[D]=m.useStateNumber({name:"changeoverHours",initialValue:3,inspector:"text",label:"Changeover Hours",description:"Hours for changeover between tests (work hours only)"}),[W]=m.useStateNumber({name:"workStart",initialValue:9,inspector:"text",label:"Work Start Hour"}),[P]=m.useStateNumber({name:"workEnd",initialValue:17,inspector:"text",label:"Work End Hour"}),[j]=m.useStateEnumeration({name:"defaultViewWeeks",initialValue:"4",enumDefinition:["2","4","8","12","24"],inspector:"segmented",label:"Default View"}),dt=Number(j)||4,[G]=m.useStateString({name:"cardMainText",initialValue:"{name}",inspector:"text",label:"Card Title",description:"Template for card title. Use {fieldName} for data fields."}),[F]=m.useStateString({name:"cardSubText",initialValue:"Parts: {part_ready_date}",inspector:"text",label:"Card Subtitle",description:"Template for subtitle. Hidden when all fields are empty."}),[ct]=m.useStateString({name:"cardInfoRow",initialValue:"{owner} \xB7 {duration}h \xB7 P{priority}",inspector:"text",label:"Card Info Row",description:"Template for the info row shown on cards and bars."}),[ut]=m.useStateString({name:"tooltipTemplate",initialValue:`Notes: {notes}
Owner: {owner}
Priority: {priority}
Part Status: {part_status}
Parts Due: {part_ready_date}
Assigned Parts: {assigned_parts}`,inspector:"text",label:"Tooltip Template",description:"Template for hover tooltip. Use \\n for newlines."}),[K]=m.useStateArray({name:"statusOptions",initialValue:["NULL","Running","Created","Tested","Cancelled"],inspector:"text",label:"Status Options",description:"Status strings shown in the right-click Change Status menu. 'NULL' clears the status."}),[,J]=m.useStateArray({name:"allocations",initialValue:[],inspector:"hidden",description:"Current allocation state: [{test_id, test_stand_id, priority_order}]"}),[,It]=m.useStateArray({name:"allTestIds",initialValue:[],inspector:"hidden",description:"All test IDs managed by the scheduler (for the delete step in save)"}),[,Q]=m.useStateBoolean({name:"hasUnsavedChanges",initialValue:!1,inspector:"hidden",description:"Whether there are unsaved allocation changes"}),[,z]=m.useStateString({name:"selectedTestId",initialValue:"",inspector:"hidden",description:"ID of test actioned via right-click menu (set before events fire)"}),[,vt]=m.useStateString({name:"selectedTestPriority",initialValue:"",inspector:"hidden",description:"New priority value from Change Priority action (numeric string)"}),[,xt]=m.useStateString({name:"selectedTestStatus",initialValue:"",inspector:"hidden",description:"New status from Change Status action. Empty string = NULL in DB."}),w=m.useEventCallback({name:"onSave"}),$=m.useEventCallback({name:"onChange"}),tt=m.useEventCallback({name:"onRetry"}),St=m.useEventCallback({name:"onChangePriority"}),Dt=m.useEventCallback({name:"onChangeStatus"}),Gt=m.useEventCallback({name:"onEditTest"});m.useComponentSettings({defaultHeight:600,defaultWidth:12});let[E,Ft]=l.default.useState([]),[B,wt]=l.default.useState([]),[et,be]=l.default.useState(dt||4),[y,Wt]=l.default.useState(null),[ve,pt]=l.default.useState(null),[Pt,nt]=l.default.useState(null),[M,Et]=l.default.useState(!1),[xe,q]=l.default.useState(!1),[Kt,ot]=l.default.useState(!1),[T,L]=l.default.useState(null),[zt,Mt]=l.default.useState(""),Lt=(0,l.useRef)(null),A=xe||g||Kt;(0,l.useEffect)(()=>{g&&q(!1),p?(q(!1),ot(!0)):g||ot(!1)},[g,p]),(0,l.useEffect)(()=>{if(!T)return;let t=r=>{Lt.current&&!Lt.current.contains(r.target)&&L(null)},s=r=>{r.key==="Escape"&&L(null)};return document.addEventListener("mousedown",t),document.addEventListener("keydown",s),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("keydown",s)}},[T]);let Nt=(0,l.useRef)(""),Jt=l.default.useRef(""),Se=(0,l.useRef)(null);(0,l.useEffect)(()=>{let t=R;if(!t||t===Jt.current)return;Jt.current=t;let s=Rt(E);Nt.current=$t(s),Et(!1),q(!1),ot(!1)},[R,E]);let[gt,De]=l.default.useState("az"),[ft,Qt]=l.default.useState(""),Fe=(0,l.useMemo)(()=>{let t=Array.isArray(K)?K:[];return t.length>0?t.map(String):["NULL","Running","Created","Tested","Cancelled"]},[K]),we=(0,l.useMemo)(()=>JSON.stringify(n)+JSON.stringify(i),[n,i]);(0,l.useEffect)(()=>{let t=Array.isArray(n)?n:[],s=Array.isArray(i)?i:[];if(s.length===0&&t.length===0)return;let r=new Map;s.forEach(c=>r.set(c.id,{id:c.id,name:c.name,tests:[]}));let f=[];t.forEach(c=>{let S={id:c.id,name:c.name||"",duration:c.duration||72,owner:c.owner||"",priority:c.priority??50,notes:c.notes||"",status:c.status||"",test_stand_id:c.test_stand_id,priority_order:c.priority_order,allocation_id:c.allocation_id,assigned_parts:c.assigned_parts||null,part_ready_date:c.part_ready_date||null,part_status:c.part_status||"",...c};S.test_stand_id!=null&&r.has(S.test_stand_id)?r.get(S.test_stand_id).tests.push(S):f.push(S)}),r.forEach(c=>{c.tests.sort((S,X)=>(S.priority_order||999)-(X.priority_order||999))});let e=s.map(c=>r.get(c.id));Ft(e),wt(f),Et(!1);let u=Rt(e);Nt.current=$t(u),J(u),It(t.map(c=>c.id)),Q(!1),q(!1),ot(!1)},[we]);let N=D||3,H=W||9,O=P||17,x=(0,l.useMemo)(()=>{let t=new Date;for(t.setHours(0,0,0,0);t.getDay()!==1;)t.setDate(t.getDate()-1);return t},[]),Ht=(0,l.useCallback)(t=>{let s=t.filter(b=>bt(b)),r=t.filter(b=>!bt(b)),f=[...s].sort((b,I)=>{let k=At(b.test_started_date)||new Date,_=At(I.test_started_date)||new Date;return k.getTime()!==_.getTime()?k.getTime()-_.getTime():(I.priority??50)-(b.priority??50)}),e=new Date(x),u=f.map(b=>{let I=At(b.test_started_date)||new Date(x),k=I<e?new Date(e):new Date(I),_=new Date(k.getTime()+b.duration*Z);return e=at(_,N,H,O),{...b,start:k,end:_}}),c=at(new Date,N,H,O),S=new Date(Math.max(e.getTime(),c.getTime())),X=r.map(b=>{let I=new Date(S),k=new Date(I.getTime()+b.duration*Z);return S=at(k,N,H,O),{...b,start:I,end:k}});return[...u,...X]},[x,N,H,O]),Xt=(0,l.useMemo)(()=>{let t=new Date(x);return t.setDate(t.getDate()+et*7),E.forEach(s=>{let r=Ht(s.tests);if(r.length>0){let f=r[r.length-1],e=at(f.end,N,H,O);e>t&&(t=e)}}),t.setDate(t.getDate()+7),t},[E,x,et,N,H,O,Ht]),rt=(0,l.useMemo)(()=>Math.ceil(Y(x,Xt)/24),[x,Xt]),C=800/(et*7*24),Ot=(0,l.useMemo)(()=>Ke(x,rt),[x,rt]),Ee=(0,l.useMemo)(()=>Je(x,rt),[x,rt]),Zt=rt*24*C,yt=24*C,Tt=(0,l.useCallback)(t=>{let s=Rt(t),r=$t(s)!==Nt.current;Et(r),J(s),Q(r),a==="live"&&(q(!0),$())},[a,J,Q,$]),mt=(0,l.useCallback)(t=>{let s=B.find(r=>r.id===t);if(s)return s;for(let r of E){let f=r.tests.find(e=>e.id===t);if(f)return f}return null},[B,E]),it=(0,l.useCallback)(()=>{Wt(null),pt(null),nt(null)},[]),Ct=(0,l.useCallback)((t,s)=>{if(!y)return;let r=mt(y);if(!r)return;wt(e=>e.filter(u=>u.id!==y));let f=E.map(e=>{let u=e.tests.filter(c=>c.id!==y);if(e.id===t){let c=[...u];return c.splice(s,0,r),{...e,tests:c}}return{...e,tests:u}});Ft(f),Tt(f),it()},[y,mt,E,Tt,it]),Vt=(0,l.useCallback)(t=>{if(!y)return;let s=mt(y);if(!s)return;let r=E.map(f=>({...f,tests:f.tests.filter(e=>e.id!==y)}));wt(f=>{let u=[...f.filter(c=>c.id!==y)];return u.splice(t,0,s),u}),Ft(r),Tt(r),it()},[y,mt,E,Tt,it]),Te=(0,l.useCallback)(()=>{q(!0),w()},[w]),te=(0,l.useCallback)(()=>{ot(!1),q(!1);let t=Array.isArray(n)?n:[],s=Array.isArray(i)?i:[],r=new Map;s.forEach(u=>r.set(u.id,{id:u.id,name:u.name,tests:[]}));let f=[];t.forEach(u=>{let c={...u,duration:u.duration||72,priority:u.priority??50};c.test_stand_id!=null&&r.has(c.test_stand_id)?r.get(c.test_stand_id).tests.push(c):f.push(c)}),r.forEach(u=>u.tests.sort((c,S)=>(c.priority_order||999)-(S.priority_order||999)));let e=s.map(u=>r.get(u.id));Ft(e),wt(f),Et(!1),J(Rt(e)),Q(!1)},[n,i,J,Q]),Ce=(0,l.useCallback)(()=>{ot(!1),q(!0),tt()},[tt]),Be=(0,l.useCallback)(()=>L(null),[]),ke=(0,l.useCallback)(t=>{L(s=>s?{...s,mode:t}:null)},[]),Re=(0,l.useCallback)(()=>{if(!T)return;let t=parseInt(zt,10);isNaN(t)||t<0||t>100||(z(String(T.test.id)),vt(String(t)),St(),L(null))},[T,zt,z,vt,St]),Ae=(0,l.useCallback)(t=>{T&&(z(String(T.test.id)),xt(t==="NULL"?"":t),Dt(),L(null))},[T,z,xt,Dt]),_e=(0,l.useCallback)(()=>{T&&(z(String(T.test.id)),Gt(),L(null))},[T,z,Gt]),ee=(0,l.useCallback)((t,s)=>({left:Math.max(0,Y(x,t))*C,width:Math.max(s*C,2)}),[x,C]),Ie=(0,l.useCallback)((t,s)=>{let r=Math.max(t.getTime(),x.getTime()),f=s.getTime();return f<=r?null:{left:Y(x,new Date(r))*C,width:Math.max(Y(new Date(r),new Date(f))*C,2)}},[x,C]),ne=y!=null?mt(y):null,st=ne!=null?bt(ne):!1,oe=E.reduce((t,s)=>t+s.tests.length,0),We=E.reduce((t,s)=>t+s.tests.reduce((r,f)=>r+f.duration,0),0),Ut=String(G||"{name}"),re=String(F||""),ie=String(ct||""),se=String(ut||"").replace(/\\n/g,`
`),ae={Running:0,Delayed:1,"On Time":2,Ready:3,"In Progress":4,"Parts Not Assigned":5},Pe=(0,l.useMemo)(()=>{let t=[...B];if(ft.trim()){let s=ft.toLowerCase().trim();t=t.filter(r=>[r.name,r.owner,r.notes,r.status,r.part_status,r.assigned_parts,r.priority!=null?String(r.priority):"",r.duration!=null?String(r.duration):""].join(" ").toLowerCase().includes(s))}return gt==="az"?t.sort((s,r)=>(s.name||"").localeCompare(r.name||"")):gt==="priority"?t.sort((s,r)=>(r.priority??50)-(s.priority??50)):t.sort((s,r)=>{let f=ae[Bt(s)]??99,e=ae[Bt(r)]??99;return f!==e?f-e:(r.priority??50)-(s.priority??50)}),t},[B,gt,ft]),ze=72,le=84;return d("div",{style:h.container,children:[A&&o(nn,{isError:Kt,onRetry:Ce,onDiscard:te}),d("div",{style:h.sidebar,children:[d("div",{style:{padding:"20px 16px 12px",borderBottom:"1px solid #E5E7EB"},children:[d("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:4},children:[d("div",{style:{display:"flex",alignItems:"center",gap:8},children:[o("div",{style:{width:8,height:8,borderRadius:"50%",background:B.length>0?"#F59E0B":"#10B981"}}),o("span",{style:{...h.mono,fontSize:13,fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",color:"#4B5563"},children:"Queue"})]}),o("div",{style:{display:"flex",gap:2,background:"#F3F4F6",borderRadius:6,padding:2,border:"1px solid #E5E7EB"},children:[["az","A\u2192Z"],["priority","Priority"],["status","Status"]].map(([t,s])=>o("button",{onClick:()=>De(t),style:{...h.mono,padding:"3px 8px",fontSize:9,fontWeight:600,borderRadius:4,border:"none",cursor:"pointer",background:gt===t?"#3B82F6":"transparent",color:gt===t?"#FFF":"#6B7280"},children:s},t))})]}),d("div",{style:{position:"relative",marginTop:6},children:[o("input",{type:"text",value:ft,onChange:t=>Qt(t.target.value),placeholder:"Filter tests...",style:{...h.mono,width:"100%",boxSizing:"border-box",padding:"5px 28px 5px 8px",fontSize:11,border:"1px solid #E5E7EB",borderRadius:6,background:"#F9FAFB",color:"#111827",outline:"none"},onFocus:t=>{t.currentTarget.style.borderColor="#3B82F6",t.currentTarget.style.background="#FFFFFF"},onBlur:t=>{t.currentTarget.style.borderColor="#E5E7EB",t.currentTarget.style.background="#F9FAFB"}}),ft&&o("button",{onClick:()=>Qt(""),style:{position:"absolute",right:6,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",color:"#9CA3AF",fontSize:14,lineHeight:1,padding:0},children:"\xD7"})]})]}),d("div",{style:{flex:1,overflowY:"auto",padding:"8px 10px"},onDragOver:t=>{t.preventDefault(),t.target===t.currentTarget&&nt(B.length)},onDragLeave:t=>{t.currentTarget===t.target&&nt(null)},onDrop:t=>{t.preventDefault(),Vt(Pt??B.length)},children:[Pe.map((t,s)=>{let r=Bt(t,null),f=!Ye(re,t);return d("div",{children:[o("div",{onDragOver:e=>{e.preventDefault(),e.stopPropagation(),nt(s)},onDrop:e=>{e.preventDefault(),e.stopPropagation(),Vt(s)},style:{height:Pt===s&&y&&y!==t.id?6:0,background:"#3B82F6",borderRadius:3,transition:"height 0.12s ease"}}),o(he,{testName:U(Ut,t),priority:t.priority,status:r,tooltipLines:U(se,t),children:d("div",{draggable:!0,onDragStart:e=>{e.dataTransfer.effectAllowed="move",Wt(t.id)},onDragEnd:it,onDragOver:e=>{e.preventDefault(),e.stopPropagation();let u=e.currentTarget.getBoundingClientRect();nt(e.clientY<u.top+u.height/2?s:s+1)},onMouseEnter:e=>{let u=e.currentTarget;u.style.transform="translateY(-2px)",u.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",u.style.border=`2px solid ${lt(r)}`},onMouseLeave:e=>{let u=e.currentTarget;u.style.transform="translateY(0)",u.style.boxShadow="0 1px 3px rgba(0,0,0,0.06)",u.style.border="1px solid #E5E7EB"},onContextMenu:e=>{e.preventDefault(),e.stopPropagation(),!(y||A)&&(Mt(String(t.priority??50)),L({x:e.clientX,y:e.clientY,test:t,mode:"root"}))},style:{display:"flex",marginBottom:6,background:y===t.id?"#F3F4F6":"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:8,cursor:"grab",opacity:y===t.id?.35:1,overflow:"hidden",boxShadow:"0 1px 3px rgba(0,0,0,0.06)",transition:"transform 0.15s ease, box-shadow 0.15s ease, border 0.15s ease"},children:[o("div",{style:{width:5,minWidth:5,background:lt(r),borderRadius:"8px 0 0 8px",flexShrink:0}}),d("div",{style:{flex:1,padding:"8px 12px",minWidth:0},children:[d("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4},children:[d("span",{style:{...h.mono,fontSize:13,fontWeight:700,color:Yt(t.priority)},children:["P",t.priority]}),o("span",{style:{...h.mono,fontSize:11,fontWeight:700,letterSpacing:"0.05em",color:_t(r),textTransform:"uppercase"},children:r.toUpperCase()})]}),o("div",{style:{fontSize:14,fontWeight:600,color:"#111827",marginBottom:2,lineHeight:1.3},children:U(Ut,t)}),f&&o("div",{style:{...h.mono,fontSize:11,color:"#6B7280",marginBottom:4,fontWeight:400},children:U(re,t)}),o("div",{style:{...h.mono,display:"flex",gap:8,fontSize:11,color:"#4B5563",flexWrap:"wrap"},children:U(ie,t).split("\xB7").map((e,u,c)=>d(l.default.Fragment,{children:[o("span",{children:e.trim()}),u<c.length-1&&o("span",{children:"\xB7"})]},u))})]})]})})]},t.id)}),o("div",{onDragOver:t=>{t.preventDefault(),nt(B.length)},onDrop:t=>{t.preventDefault(),Vt(B.length)},style:{height:Pt===B.length&&y?6:0,background:"#3B82F6",borderRadius:3,transition:"height 0.12s ease",margin:"0 4px"}}),B.length===0&&o("div",{style:{textAlign:"center",padding:"32px 16px",color:"#6B7280",fontSize:12,border:y?"2px dashed #3B82F6":"2px dashed #D1D5DB",borderRadius:8,marginTop:8,background:y?"#EFF6FF":"transparent"},children:y?"Drop to return to queue":"All tests allocated"})]}),o(tn,{}),o("div",{style:{padding:"12px 16px",borderTop:"1px solid #E5E7EB",background:"#F9FAFB"},children:d("div",{style:{...h.mono,display:"flex",justifyContent:"space-between",fontSize:10,color:"#6B7280"},children:[d("span",{children:[oe,"/",oe+B.length," allocated"]}),d("span",{children:[We,"h"]})]})})]}),d("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[d("div",{style:{padding:"12px 24px",borderBottom:"1px solid #E5E7EB",background:"#FFFFFF",display:"flex",alignItems:"center",justifyContent:"space-between",gap:16,flexWrap:"wrap"},children:[d("div",{style:{minWidth:0},children:[o("h1",{style:{fontSize:18,fontWeight:700,color:"#111827",letterSpacing:"-0.02em"},children:"Test Stand Scheduler"}),d("p",{style:{...h.mono,fontSize:11,color:"#6B7280",marginTop:2},children:["Continuous testing \xB7 ",N,"h changeover (",H,":00\u2013",O,":00 Mon\u2013Fri)",a==="live"&&o("span",{children:" \xB7 Live sync"})]})]}),d("div",{style:{display:"flex",alignItems:"center",gap:12},children:[a==="batch"&&d("div",{style:{display:"flex",gap:6},children:[o("button",{onClick:te,disabled:!M||A,style:{...h.mono,padding:"6px 14px",fontSize:11,fontWeight:600,borderRadius:6,border:"1px solid #D1D5DB",cursor:M&&!A?"pointer":"default",background:"#FFFFFF",color:M&&!A?"#374151":"#9CA3AF",opacity:M&&!A?1:.5},children:"Discard"}),d("button",{onClick:Te,disabled:!M||A,style:{...h.mono,padding:"6px 14px",fontSize:11,fontWeight:600,borderRadius:6,border:"none",cursor:M&&!A?"pointer":"default",background:M&&!A?"#3B82F6":"#93C5FD",color:"#FFFFFF",boxShadow:M&&!A?"0 1px 3px rgba(59,130,246,0.3)":"none"},children:["Save Changes",M&&" \u2022"]})]}),o("div",{style:{display:"flex",gap:4,background:"#F3F4F6",borderRadius:8,padding:3,border:"1px solid #E5E7EB"},children:[2,4,8,12,24].map(t=>d("button",{onClick:()=>be(t),style:{...h.mono,padding:"6px 12px",fontSize:11,fontWeight:600,borderRadius:6,border:"none",cursor:"pointer",background:et===t?"#3B82F6":"transparent",color:et===t?"#FFF":"#4B5563"},children:[t,"W"]},t))})]})]}),o("div",{ref:Se,style:{flex:1,overflow:"auto",background:"#F9FAFB"},children:d("div",{style:{minWidth:Zt,padding:"0 12px 24px",position:"relative"},children:[d("div",{style:{position:"sticky",top:0,zIndex:20,background:"#F9FAFB",borderBottom:"1px solid #E5E7EB"},children:[o("div",{style:{display:"flex",height:28,position:"relative",borderBottom:"1px solid #E5E7EB"},children:Ee.map((t,s)=>o("div",{style:{...h.mono,position:"absolute",left:Y(x,t)*C,width:7*24*C,height:28,display:"flex",alignItems:"center",paddingLeft:8,fontSize:10,fontWeight:600,color:"#4B5563",borderLeft:s>0?"1px solid #E5E7EB":"none"},children:Qe(t)},s))}),o("div",{style:{display:"flex",height:24},children:Ot.map((t,s)=>{let r=t.toDateString()===new Date().toDateString(),f=t.getDay()===0||t.getDay()===6;return o("div",{style:{...h.mono,width:yt,minWidth:yt,fontSize:9,textAlign:"center",color:r?"#2563EB":"#6B7280",fontWeight:r?700:400,lineHeight:"24px",borderLeft:"1px solid #E5E7EB",background:r?"#EFF6FF":f?"#F3F4F6":"transparent"},children:et<=8||t.getDay()===1?t.getDate():""},s)})})]}),E.map(t=>{let s=Ht(t.tests),r=ve,f=r&&r.standId===t.id;return d("div",{style:{marginTop:16},children:[d("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6,paddingLeft:2},children:[o("div",{style:{width:6,height:6,borderRadius:2,background:t.tests.length>0?"#3B82F6":"#9CA3AF"}}),o("span",{style:{...h.mono,fontSize:11,fontWeight:600,color:"#374151"},children:t.name}),d("span",{style:{...h.mono,fontSize:10,color:"#6B7280"},children:[t.tests.length," test",t.tests.length!==1?"s":"",t.tests.length>0&&` \xB7 ${t.tests.reduce((e,u)=>e+u.duration,0)}h`]})]}),d("div",{onDragOver:e=>{e.preventDefault(),pt({standId:t.id,index:t.tests.length})},onDragLeave:e=>{e.currentTarget.contains(e.relatedTarget)||pt(null)},onDrop:e=>{e.preventDefault(),st?Ct(t.id,t.tests.length):Ct(t.id,r?.standId===t.id?r.index:t.tests.length)},style:{position:"relative",height:le,background:(()=>f||y&&t.tests.length===0?st?"#F5F3FF":"#EFF6FF":"#F3F4F6")(),border:`1px solid ${(()=>f||y&&t.tests.length===0?st?"#A78BFA":"#BFDBFE":"#E5E7EB")()}`,borderRadius:8,width:Zt,transition:"background 0.15s ease, border-color 0.15s ease"},children:[Ot.map((e,u)=>e.getDay()!==0&&e.getDay()!==6?null:o("div",{style:{position:"absolute",left:u*yt,top:0,bottom:0,width:yt,background:"#E5E7EB",pointerEvents:"none"}},`we-${u}`)),Ot.map((e,u)=>o("div",{style:{position:"absolute",left:u*yt,top:0,bottom:0,width:1,background:"#E5E7EB"}},u)),(()=>{let e=Y(x,new Date);return e<0||e>rt*24?null:o("div",{style:{position:"absolute",left:e*C,top:0,bottom:0,width:2,background:"#EF4444",zIndex:10},children:o("div",{style:{position:"absolute",top:-3,left:-3,width:8,height:8,borderRadius:"50%",background:"#EF4444"}})})})(),s.map((e,u)=>{let c=bt(e),S=c?Ie(e.start,e.end):ee(e.start,e.duration);if(!S)return null;let{left:X,width:b}=S,I=at(e.end,N,H,O),k=Y(e.end,I)*C,_=Bt(e,e.start),de=U(Ut,e),ce=U(ie,e),Me=ce.trim()!==""&&b>120;return d("div",{style:{position:"absolute",left:X,top:0,width:b+k,height:"100%"},children:[y&&y!==e.id&&!st&&d(ht,{children:[o("div",{onDragOver:v=>{v.preventDefault(),v.stopPropagation(),pt({standId:t.id,index:u})},onDrop:v=>{v.preventDefault(),v.stopPropagation(),Ct(t.id,u)},style:{position:"absolute",left:-6,top:0,width:"50%",height:"100%",zIndex:20,minWidth:20}}),o("div",{onDragOver:v=>{v.preventDefault(),v.stopPropagation(),pt({standId:t.id,index:u+1})},onDrop:v=>{v.preventDefault(),v.stopPropagation(),Ct(t.id,u+1)},style:{position:"absolute",right:-6,top:0,width:"50%",height:"100%",zIndex:20,minWidth:20}})]}),f&&!st&&r.index===u&&o("div",{style:{position:"absolute",left:-4,top:0,bottom:0},children:o(me,{})}),o(he,{testName:de,priority:e.priority,status:_,tooltipLines:U(se,e),scheduled:c?null:e,wrapperStyle:{position:"absolute",left:0,top:0,width:b,height:"100%"},children:d("div",{draggable:!0,onDragStart:v=>{v.dataTransfer.effectAllowed="move",v.dataTransfer.setData("text/plain",String(e.id)),Wt(e.id)},onDragEnd:it,onMouseEnter:v=>{if(!y){let V=v.currentTarget;V.style.transform="translateY(-2px)",V.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",V.style.border=`2px solid ${lt(_)}`,V.style.zIndex="25"}},onMouseLeave:v=>{let V=v.currentTarget;V.style.transform="translateY(0)",V.style.boxShadow="0 1px 3px rgba(0,0,0,0.06)",V.style.border=c?"1px solid #C4B5FD":"1px solid #E5E7EB",V.style.zIndex="15"},onContextMenu:v=>{v.preventDefault(),v.stopPropagation(),!(y||A)&&(Mt(String(e.priority??50)),L({x:v.clientX,y:v.clientY,test:e,mode:"root"}))},style:{position:"absolute",left:0,top:6,width:b,height:ze,background:c?"#F3E8FF":"#FFFFFF",borderRadius:8,cursor:"grab",display:"flex",flexDirection:"row",overflow:"hidden",opacity:y===e.id?.25:1,zIndex:15,border:c?"1px solid #C4B5FD":"1px solid #E5E7EB",boxShadow:c?"0 1px 3px rgba(147,51,234,0.15)":"0 1px 3px rgba(0,0,0,0.06)",transition:"transform 0.15s ease, box-shadow 0.15s ease, border 0.15s ease"},children:[o("div",{style:{width:5,minWidth:5,background:lt(_),flexShrink:0}}),d("div",{style:{flex:1,display:"flex",flexDirection:"column",padding:"4px 8px",minWidth:0,justifyContent:"center"},children:[b>70&&d("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:2},children:[o("span",{style:{...h.mono,fontSize:b>120?11:9,fontWeight:700,color:c?"#7E22CE":Yt(e.priority)},children:c?"\u25B6 RUNNING":`P${e.priority}`}),b>100&&!c&&o("span",{style:{...h.mono,fontSize:9,fontWeight:700,letterSpacing:"0.05em",color:_t(_),textTransform:"uppercase"},children:_.toUpperCase()})]}),o("span",{style:{fontSize:b>120?12:b>80?11:10,fontWeight:600,color:c?"#3B0764":"#111827",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:"100%",lineHeight:1.2},children:de}),Me&&o("span",{style:{...h.mono,fontSize:9,fontWeight:400,color:c?"#7E22CE":"#4B5563",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:"100%",marginTop:2},children:ce})]})]})}),u<s.length&&k>0&&o("div",{style:{position:"absolute",left:b,top:le/2-8,width:k,height:16,display:"flex",alignItems:"center",justifyContent:"center"},children:o("div",{style:{height:1,width:"80%",background:"repeating-linear-gradient(90deg, #9CA3AF 0, #9CA3AF 4px, transparent 4px, transparent 8px)"}})})]},e.id)}),f&&!st&&r.index===t.tests.length&&s.length>0&&(()=>{let e=s[s.length-1],{left:u,width:c}=ee(e.start,e.duration),S=at(e.end,N,H,O),X=Y(e.end,S)*C;return o("div",{style:{position:"absolute",left:u+c+X+8,top:0,bottom:0},children:o(me,{})})})(),t.tests.length===0&&o("div",{style:{...h.mono,position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,color:y?"#3B82F6":"#9CA3AF",fontWeight:y?600:400},children:y?"Drop here to schedule":"Drop tests here to schedule"})]})]},t.id)}),E.length===0&&o("div",{style:{...h.mono,textAlign:"center",padding:"48px 24px",color:"#6B7280",fontSize:12},children:"No test stands loaded. Bind the testStands property to your getTestStands query."})]})})]}),T&&o(en,{menu:T,statusOptionsList:Fe,priorityInputValue:zt,onClose:Be,onModeChange:ke,onPriorityInputChange:Mt,onConfirmPriority:Re,onPickStatus:Ae,onEditTest:_e,panelRef:Lt})]})};export{pn as TestStandScheduler};
